!function(e){"use strict";var t,n=Stripe(dokanStripeExpressPRData.stripe.key,{locale:dokanStripeExpressPRData.stripe.locale,apiVersion:dokanStripeExpressPRData.stripe.apiVersion}),a={ajaxEndpoint:function(e){return dokanStripeExpressPRData.ajaxUrl.toString().replace("%%endpoint%%","dokan_stripe_express_"+e)},makeRequest:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"POST",o={type:s,data:n,url:a.ajaxEndpoint(t)};return r&&(o.dataType=r),e.ajax(o)},getCartDetails:function(){e.when(a.makeRequest("get_cart_details",{security:dokanStripeExpressPRData.nonce.payment})).then(a.startPaymentRequest)},getAttributes:function(){var t=e(".variations_form").find(".variations select"),n={},a=0,r=0;return t.each((function(){var t=e(this).data("attribute_name")||e(this).attr("name"),s=e(this).val()||"";s.length>0&&r++,a++,n[t]=s})),{count:a,chosenCount:r,data:n}},processSource:function(e,t){return a.makeRequest("create_order",a.getOrderData(e,t),"json")},getOrderData:function(e,t){var n=e.source,a=n.owner.email,r=n.owner.phone,s=n.owner.address,o=n.owner.name,i=e.shippingAddress,p={_wpnonce:dokanStripeExpressPRData.nonce.checkout,billing_company:"",billing_first_name:null!==o?o.split(" ").slice(0,1).join(" "):"",billing_last_name:null!==o?o.split(" ").slice(1).join(" "):"",billing_email:null!==a?a:e.payerEmail,billing_phone:null!==r?r:e.payerPhone&&e.payerPhone.replace("/[() -]/g",""),billing_country:null!==s?s.country:"",billing_address_1:null!==s?s.line1:"",billing_address_2:null!==s?s.line2:"",billing_city:null!==s?s.city:"",billing_state:null!==s?s.state:"",billing_postcode:null!==s?s.postal_code:"",shipping_first_name:"",shipping_last_name:"",shipping_company:"",shipping_country:"",shipping_address_1:"",shipping_address_2:"",shipping_city:"",shipping_state:"",shipping_postcode:"",shipping_method:[null===e.shippingOption?null:e.shippingOption.id],order_comments:"",payment_method:dokanStripeExpressPRData.stripe.paymentMethod,ship_to_different_address:1,terms:1,stripe_source:n.id,payment_request_type:t};return i&&(p.shipping_first_name=i.recipient.split(" ").slice(0,1).join(" "),p.shipping_last_name=i.recipient.split(" ").slice(1).join(" "),p.shipping_company=i.organization,p.shipping_country=i.country,p.shipping_address_1=void 0===i.addressLine[0]?"":i.addressLine[0],p.shipping_address_2=void 0===i.addressLine[1]?"":i.addressLine[1],p.shipping_city=i.city,p.shipping_state=i.region,p.shipping_postcode=i.postalCode),p.billing_first_name||(p.billing_first_name=p.shipping_first_name?p.shipping_first_name:dokanStripeExpressPRData.customer.first_name),p.billing_last_name||(p.billing_last_name=p.shipping_last_name?p.shipping_last_name:dokanStripeExpressPRData.customer.last_name),p},prepareErrorMessage:function(t){return e('<div class="woocommerce-error" />').text(t)},showErrorMessage:function(t){if(e(".woocommerce-error").remove(),dokanStripeExpressPRData.isProductPage){var n=e(".product").first();n.before(t),e("html, body").animate({scrollTop:n.prev(".woocommerce-error").offset().top},600)}else{var a=e(".shop_table.cart").closest("form");a.before(t),e("html, body").animate({scrollTop:a.prev(".woocommerce-error").offset().top},600)}},abortPayment:function(e,t){e.complete("fail"),a.showErrorMessage(t)},completePayment:function(e,t){a.block(),e.complete("success"),window.location=t},block:function(){e.blockUI({message:null,overlayCSS:{background:"#fff",opacity:.6}})},updateShippingOptions:function(e,n){return a.makeRequest("get_shipping_options",{security:dokanStripeExpressPRData.nonce.shipping,country:n.country,state:n.region,postcode:n.postalCode,city:n.city,address:void 0===n.addressLine[0]?"":n.addressLine[0],address_2:void 0===n.addressLine[1]?"":n.addressLine[1],payment_request_type:t,is_product_page:dokanStripeExpressPRData.isProductPage})},updateShippingDetails:function(e,n){return a.makeRequest("update_shipping_method",{security:dokanStripeExpressPRData.nonce.updateShipping,shipping_method:[n.id],payment_request_type:t,is_product_page:dokanStripeExpressPRData.isProductPage})},addToCart:function(){var t=e(".single_add_to_cart_button").val();e(".single_variation_wrap").length&&(t=e(".single_variation_wrap").find('input[name="product_id"]').val());var n={security:dokanStripeExpressPRData.nonce.addToCart,product_id:t,qty:e(".quantity .qty").val(),attributes:e(".variations_form").length?a.getAttributes().data:[]},r=e("form.cart").serializeArray();return e.each(r,(function(e,t){if(/^addon-/.test(t.name))if(/\[\]$/.test(t.name)){var a=t.name.substring(0,t.name.length-2);n[a]?n[a].push(t.value):n[a]=[t.value]}else n[t.name]=t.value})),a.makeRequest("add_to_cart",n)},clearCart:function(){a.makeRequest("clear_cart",{security:dokanStripeExpressPRData.nonce.clearCart})},getRequestOptionsFromLocal:function(){return{total:dokanStripeExpressPRData.product.total,currency:dokanStripeExpressPRData.checkout.currencyCode,country:dokanStripeExpressPRData.checkout.countryCode,requestPayerName:!0,requestPayerEmail:!0,requestPayerPhone:dokanStripeExpressPRData.checkout.payerPhoneNeeded,requestShipping:dokanStripeExpressPRData.product.requestShipping,displayItems:dokanStripeExpressPRData.product.displayItems}},startPaymentRequest:function(r){var s,o;dokanStripeExpressPRData.isProductPage?(o=a.getRequestOptionsFromLocal(),s=o):(o={total:r.order_data.total,currency:r.order_data.currency,country:r.order_data.country_code,requestPayerName:!0,requestPayerEmail:!0,requestPayerPhone:dokanStripeExpressPRData.checkout.payerPhoneNeeded,requestShipping:!!r.shipping_required,displayItems:r.order_data.displayItems},s=r.order_data),"PR"===o.country&&(o.country="US");try{var i=n.paymentRequest(o),p=n.elements({locale:dokanStripeExpressPRData.button.locale}),u=a.createPaymentRequestButton(p,i);i.canMakePayment().then((function(e){e&&(t=e.applePay?"apple_pay":e.googlePay?"google_pay":"payment_request_api",a.attachBtnEventListeners(u,i),a.showPaymentRequestButton(u))})),i.on("shippingaddresschange",(function(t){e.when(a.updateShippingOptions(s,t.shippingAddress)).then((function(e){var n={status:e.result,shippingOptions:[],total:e.total,displayItems:e.displayItems};e.shipping_options&&e.shipping_options.length&&(n.shippingOptions=e.shipping_options),t.updateWith(n)}))})),i.on("shippingoptionchange",(function(t){e.when(a.updateShippingDetails(s,t.shippingOption)).then((function(e){"success"===e.result&&t.updateWith({status:"success",total:e.total,displayItems:e.displayItems}),"fail"===e.result&&t.updateWith({status:"fail"})}))})),i.on("source",(function(n){"no"===dokanStripeExpressPRData.stripe.allowPrepaidCard&&"prepaid"===n.source.card.funding?a.abortPayment(n,a.dokanStripeExpressPaymentRequest.prepareErrorMessage(dokanStripeExpressPRData.i18n.error.noPrepaidCard)):e.when(a.processSource(n,t)).then((function(e){"success"===e.result?a.completePayment(n,e.redirect):a.abortPayment(n,e.messages)}))}))}catch(e){console.error(e)}},getSelectedProductData:function(){var t=e(".single_add_to_cart_button").val();e(".single_variation_wrap").length&&(t=e(".single_variation_wrap").find('input[name="product_id"]').val());var n=(e("#product-addons-total").data("price_data")||[]).reduce((function(e,t){return e+t.cost}),0);return a.makeRequest("get_selected_product_data",{security:dokanStripeExpressPRData.nonce.getSelectedProductData,product_id:t,qty:e(".quantity .qty").val(),attributes:e(".variations_form").length?a.getAttributes().data:[],addon_value:n})},debounce:function(e,t,n){var a;return function(){var r=this,s=arguments,o=function(){a=null,n||t.apply(r,s)},i=n&&!a;clearTimeout(a),a=setTimeout(o,e),i&&t.apply(r,s)}},createPaymentRequestButton:function(e,t){return e.create("paymentRequestButton",{paymentRequest:t,style:{paymentRequestButton:{type:dokanStripeExpressPRData.button.type,theme:dokanStripeExpressPRData.button.theme,height:dokanStripeExpressPRData.button.height+"px"}}})},isCustomPRButton:function(e){return e&&"function"==typeof e.data&&e.data("isCustom")},isBrandedPRButton:function(e){return e&&"function"==typeof e.data&&e.data("isBranded")},attachBtnEventListeners:function(t,n){t.on("click",(function(t){e("body").addClass("dokan-stripe-express-pay-req-btn-clicked")})),dokanStripeExpressPRData.isProductPage?a.attachProductPageEventListeners(t,n):a.attachCartPageEventListeners(t,n)},attachProductPageEventListeners:function(n,r){var s=[],o=e(".single_add_to_cart_button");n.on("click",(function(e){if(dokanStripeExpressPRData.loginStatus)return e.preventDefault(),void a.verifyLoginRequirement(t);if(o.is(".disabled")){if(e.preventDefault(),o.is(".wc-variation-is-unavailable"))return dokan_sweetalert(dokanStripeExpressPRData.i18n.makeSelection,{action:"alert",icon:"warning",timer:2200});if(o.is(".wc-variation-selection-needed"))return dokan_sweetalert(dokanStripeExpressPRData.i18n.productUnavailable,{action:"alert",icon:"warning",timer:2200})}if(s.length)return e.preventDefault(),dokan_sweetalert(s,{action:"alert",icon:"error",timer:2200});a.addToCart(),(a.isCustomPRButton(n)||a.isBrandedPRButton(n))&&(e.preventDefault(),r.show())})),e(document.body).on("dokan_stripe_express_unblock_payment_request_button dokan_stripe_express_enable_payment_request_button",(function(){a.unblockPaymentRequestButton()})),e(document.body).on("dokan_stripe_express_block_payment_request_button",(function(){a.blockPaymentRequestButton("wc_request_button_is_blocked")})),e(document.body).on("dokan_stripe_express_disable_payment_request_button",(function(){a.blockPaymentRequestButton("wc_request_button_is_disabled")})),e(document.body).on("woocommerce_variation_has_changed",(function(){e(document.body).trigger("dokan_stripe_express_block_payment_request_button"),e.when(a.getSelectedProductData()).then((function(t){e.when(r.update({total:t.total,displayItems:t.displayItems})).then((function(){e(document.body).trigger("dokan_stripe_express_unblock_payment_request_button")}))}))})),e(".quantity").on("input",".qty",(function(){e(document.body).trigger("dokan_stripe_express_block_payment_request_button")})),e(".quantity").on("input",".qty",a.debounce(250,(function(){e(document.body).trigger("dokan_stripe_express_block_payment_request_button"),s=[],e.when(a.getSelectedProductData()).then((function(t){t.error?(s=[t.error],e(document.body).trigger("dokan_stripe_express_unblock_payment_request_button")):e.when(r.update({total:t.total,displayItems:t.displayItems})).then((function(){e(document.body).trigger("dokan_stripe_express_unblock_payment_request_button")}))}))}))),e(".variations_form").length&&e(".variations_form").on("found_variation.wc-variation-form",(function(e,t){t.is_in_stock?a.unhidePaymentRequestButton():a.hidePaymentRequestButton()}))},attachCartPageEventListeners:function(e,n){e.on("click",(function(r){if(dokanStripeExpressPRData.loginStatus)return r.preventDefault(),void a.verifyLoginRequirement(t);(a.isCustomPRButton(e)||a.isBrandedPRButton(e))&&(r.preventDefault(),n.show())}))},showPaymentRequestButton:function(t){a.isCustomPRButton(t)?(t.addClass("is-active"),e("#dokan-stripe-express-payment-request-wrapper, #dokan-stripe-express-payment-request-button-separator").show()):a.isBrandedPRButton(t)?(e("#dokan-stripe-express-payment-request-wrapper, #dokan-stripe-express-payment-request-button-separator").show(),e("#dokan-stripe-express-payment-request-button").html(t)):e("#dokan-stripe-express-payment-request-button").length&&(e("#dokan-stripe-express-payment-request-wrapper, #dokan-stripe-express-payment-request-button-separator").show(),t.mount("#dokan-stripe-express-payment-request-button"))},hidePaymentRequestButton:function(){e("#dokan-stripe-express-payment-request-wrapper, #dokan-stripe-express-payment-request-button-separator").hide()},unhidePaymentRequestButton:function(){var t=e("#dokan-stripe-express-payment-request-wrapper"),n=e("#dokan-stripe-express-payment-request-button-separator");(t.is(":hidden")||n.is(":hidden"))&&(t.show(),n.show())},blockPaymentRequestButton:function(t){e("#dokan-stripe-express-payment-request-button").data("blockUI.isBlocked")||e("#dokan-stripe-express-payment-request-button").addClass(t).block({message:null})},unblockPaymentRequestButton:function(){e("#dokan-stripe-express-payment-request-button").removeClass(["wc_request_button_is_blocked","wc_request_button_is_disabled"]).unblock()},verifyLoginRequirement:function(e){if(dokanStripeExpressPRData.loginStatus){var t=dokanStripeExpressPRData.loginStatus.message;"payment_request_api"!==e&&(t=t.replace(/\*\*.*?\*\*/,"apple_pay"===e?dokanStripeExpressPRData.i18n.applePay:dokanStripeExpressPRData.i18n.googlePay)),t=t.replace(/\*\*/g,""),dokan_sweetalert(t,{action:"confirm",icon:"warning",confirmButtonColor:"#363636",cancelButtonColor:"#b54545",confirmButtonText:dokanStripeExpressPRData.i18n.login,cancelButtonText:dokanStripeExpressPRData.i18n.cancel}).then((function(e){e.isConfirmed&&(window.location.href=dokanStripeExpressPRData.loginStatus.redirect_url)}))}},init:function(){dokanStripeExpressPRData.isProductPage?a.startPaymentRequest(""):a.getCartDetails()}};a.init(),e(document.body).on("updated_cart_totals",(function(){a.init()})),e(document.body).on("updated_checkout",(function(){a.init()}))}(jQuery);